#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "ğŸ§ª Running dependency safety checks before commit..."

pnpm install
pnpm audit --audit-level=low

# Filter outdated results against allowlist and remove table headers
pnpm outdated > outdated.log || true
ALLOWLIST=$(paste -sd '|' criticalPackagesAllowList.txt)
grep -vE "$ALLOWLIST" outdated.log | grep -E 'â”‚ [^â”‚]+ â”‚ [^â”‚]+ â”‚ [^â”‚]+ â”‚' > critical.log || true

if grep -qE 'â”‚ [^â”‚]+ â”‚ [^â”‚]+ â”‚ [^â”‚]+ â”‚' critical.log; then
  echo "âŒ Real critical outdated packages found:"
  cat critical.log
  exit 1
else
  echo "âœ… No critical outdated packages."
fi

pnpm lint || true
pnpm check || true
npx socket protect || true

echo "âœ… Dependency check complete."
